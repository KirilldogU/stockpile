---

- id: 30a8cf10-73dc-497c-8261-a64cc9e91505
  name: Compress staged directory (Password Protected)
  description: This ability packages staged files into a password-protected archive. Note - Requires 7Z for Windows and GPG version 2.1+ for Linux
  tactic: collection
  technique:
    attack_id: T1560.001
    name: "Archive Collected Data: Archive via Utility"
  platforms:
    linux:
      sh:
        command: |
          tar -C #{file.dir} -czf - . | gpg -c --pinentry-mode=loopback --passphrase #{custom.archive_password} > #{file.dir}.tar.gz.gpg && echo #{file.dir}.tar.gz.gpg
        cleanup: |
          rm #{file.dir}.tar.gz.gpg
        parsers:
          plugins.stockpile.app.parsers.basic:
            - source: file.staged_at
              edge: is_compressed
    windows:
      psh:
        command: |
          & "C:\Program Files\7-Zip\7z.exe" a "#{file.dir}.7z" "#{file.dir}\*" "-p#{custom.archive_password}" | Out-Null;
          sleep 1; ls #{file.dir}.7z | foreach {$_.FullName} | select
        cleanup: |
          rm #{file.dir}.7z
        parsers:
          plugins.stockpile.app.parsers.basic:
            - source: file.staged_at
              edge: is_compressed
  requirements:
    - plugins.stockpile.app.requirements.paw_provenance:
      - source: file.dir