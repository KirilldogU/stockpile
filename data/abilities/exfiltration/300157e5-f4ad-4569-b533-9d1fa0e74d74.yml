---

- id: 300157e5-f4ad-4569-b533-9d1fa0e74d74
  name: Compress staged directory
  description: Compress a directory on the file system
  tactic: exfiltration
  technique:
    attack_id: T1560.001
    name: "Archive Collected Data: Archive via Utility"
  platforms:
    darwin:
      sh:
        command: |
          tar -P -zcf #{file.path}.tar.gz #{file.path} && echo #{file.path}.tar.gz
        cleanup: |
          rm #{file.path}.tar.gz
        parsers:
          plugins.stockpile.app.parsers.basic:
            - source: file.staged_at
              edge: is_compressed
    linux:
      sh:
        command: |
          tar -P -zcf #{file.path}.tar.gz #{file.path} && echo #{file.path}.tar.gz
        cleanup: |
          rm #{file.path}.tar.gz
        parsers:
          plugins.stockpile.app.parsers.basic:
            - source: file.staged_at
              edge: is_compressed
    windows:
      psh,pwsh:
        command: |
          Compress-Archive -Path #{file.path} -DestinationPath #{file.path}.zip -Force;
          sleep 1; ls #{file.path}.zip | foreach {$_.FullName} | select
        cleanup: |
          rm #{file.path}.zip
        parsers:
          plugins.stockpile.app.parsers.basic:
            - source: file.staged_at
              edge: is_compressed
  requirements:
    - plugins.stockpile.app.requirements.paw_provenance:
      - source: file.path